<div class="animated fadeIn create-bulletin" [class.create-bulletin--modal]="showNewVariantModal && activeVariant">
  <!-- Sidebar -->
  <aside class="create-bulletin__sidebar" [class.hidden]="!isVariantsSidebarVisible">
    <!-- Date Switch -->
    <header class="create-bulletin__sidebar-header">
      <button
        (click)="toggleVariantsSidebar()"
        class="btn btn-bare btn-sm btn-icon btn-bare--grey d-block d-md-none create-bulletin__sidebar-close"
      >
        <i class="ph-bold ph-x"></i>
      </button>

      <div class="create-bulletin__date">
        <h1 class="create-bulletin__current-date font-m-bold">
          {{ dangerSourcesService.getActiveDate()[1] | date: "EEEE," : undefined : translateService.currentLang }}<br />
          {{ dangerSourcesService.getActiveDate()[1] | date: "longDate" : undefined : translateService.currentLang }}
        </h1>
        <nav class="btn-group create-bulleting__days-nav">
          <button
            type="button"
            class="btn btn-icon btn-sm btn-bare--grey"
            (click)="changeDate(dangerSourcesService.getNextDate())"
            *ngIf="dangerSourcesService.getNextDate()"
          >
            <i class="ph-bold ph-caret-left"></i>
          </button>
          <button
            type="button"
            class="btn btn-icon btn-sm btn-bare--grey"
            (click)="changeDate(dangerSourcesService.getPreviousDate())"
            *ngIf="dangerSourcesService.getPreviousDate()"
          >
            <i class="ph-bold ph-caret-right"></i>
          </button>
        </nav>
      </div>
      <!-- End Date Switch -->

      <span class="create-bulletin__bulletin-info" *ngIf="loading"
        ><i class="ph ph-circle-notch"></i> {{ "bulletins.status.loading" | translate }}</span
      >
      <span class="create-bulletin__bulletin-alert" *ngIf="saveError.size" (click)="updateSaveErrors()"
        ><i class="ph ph-warning icon-left"></i> {{ "bulletins.status.saveError" | translate }}
        <button class="btn btn-outline btn-danger btn-small lm-2">
          <i class="ph ph-repeat icon-right"></i>
        </button>
      </span>
      <span class="create-bulletin__bulletin-warning" *ngIf="loadInternalVariantsError"
        ><i class="ph ph-info"></i> {{ "bulletins.status.loadBulletinsError" | translate }}</span
      >
    </header>
    <!-- End sidebar header -->

    <!-- List of regions -->
    <div class="create-bulletin__regions">
      <!-- Own regions -->
      <header class="create-bulletin__region-divider">
        <h5 class="font-s-bold">
          {{ "bulletins.table.title.status." + authenticationService?.getActiveRegion().id | translate }} ({{
            getOwnVariants().length
          }})
        </h5>
        <div class="btn-group region-divider__actions">
          <div class="region-divider__actions-dropdown mr-1" bsDropdown container="body">
            <button class="btn btn-sm btn-icon btn-bare--grey" type="button" bsDropdownToggle>
              <i class="ph-bold ph-dots-three-outline-vertical"></i>
            </button>

            <ul *bsDropdownMenu class="dropdown-menu create-bulletin__region-dropdown">
              <!-- map above / map aside -->
              <li>
                <button class="dropdown-item" (click)="toggleCompactMapLayout()">
                  <i *ngIf="isCompactMapLayout" class="ph icon-md ph-square-split-horizontal"></i>
                  <i *ngIf="!isCompactMapLayout" class="ph icon-md ph-square-split-vertical"></i>
                  <span *ngIf="isCompactMapLayout">{{ "bulletins.create.mapLeft" | translate }}</span>
                  <span *ngIf="!isCompactMapLayout">{{ "bulletins.create.mapTop" | translate }}</span>
                </button>
              </li>

              <!-- load bulletin from yesterday -->
              <li>
                <button
                  *ngIf="dangerSourcesService.getIsEditable() && !dangerSourcesService.getIsReadOnly()"
                  [disabled]="editRegions || loading"
                  type="reset"
                  class="dropdown-item"
                  (click)="loadVariantsFromYesterday()"
                  data-toggle="tooltip"
                  title="{{ 'bulletins.create.tooltip.loadBulletin' | translate }}"
                >
                  <i class="ph-bold ph-copy icon-md"></i>
                  {{ "bulletins.create.tooltip.loadBulletin" | translate }}
                </button>
              </li>
            </ul>
          </div>
          <button
            [disabled]="editRegions || loading"
            *ngIf="dangerSourcesService.getIsEditable()"
            (click)="createVariant(false)"
            class="btn btn-sm btn-icon btn-primary"
            type="button"
            title="{{ 'bulletins.create.createAggregatedRegion' | translate }}"
          >
            <i class="ph-bold ph-plus"></i>
          </button>
        </div>
      </header>
      <!-- End own regions header -->
      <!-- List of own regions -->
      <nav class="create-bulletin__region-list">
        <!-- Show the list of variants if there are any -->
        <ng-container *ngIf="getOwnVariants().length; else noVariantsTemplate">
          <ng-container *ngFor="let bulletin of getOwnBulletins()">
            <ng-container *ngTemplateOutlet="variantTemplate; context: { variant: variant }"></ng-container>
          </ng-container>
        </ng-container>
      </nav>
    </div>

    <div class="create-bulletin__regions">
      <!-- Foreign regions -->
      <header class="create-bulletin__region-divider foreign" (click)="toggleShowForeignRegions()">
        <h5 class="font-s-bold">
          {{ "bulletins.create.foreignRegions" | translate }} ({{ getForeignVariants().length }})
        </h5>
        <div class="btn-group region-divider__actions">
          <div class="region-divider__actions-dropdown mr-1">
            <button class="btn btn-sm btn-icon btn-bare--grey" type="button">
              <i *ngIf="!showForeignRegions" class="ph-bold ph-caret-right"></i>
              <i *ngIf="showForeignRegions" class="ph-bold ph-caret-down"></i>
            </button>
          </div>
        </div>
      </header>
      <!-- List of foreign regions -->
      <nav *ngIf="showForeignRegions" class="create-bulletin__region-list">
        <ng-container *ngFor="let bulletin of getForeignVariants()">
          <ng-container *ngTemplateOutlet="variantTemplate; context: { variant: variant }"></ng-container>
        </ng-container>
      </nav>
    </div>
    <!-- End list of regions -->
  </aside>
  <!-- End Sidebar -->

  <div
    class="create-bulletin__default-layout"
    [class.create-bulletin__compact-layout]="
      activeVariant !== undefined && !editRegions && (isCompactMapLayout || comparedVariant !== undefined)
    "
    [class.create-bulletin__compact-layout--compare]="
      activeVariant !== undefined && !editRegions && comparedVariant !== undefined
    "
    [class.full-width]="!isVariantsSidebarVisible"
  >
    <!-- Active variant -->
    <div
      *ngIf="activeVariant && !showNewVariantModal"
      class="create-bulletin__region-form"
      (scroll)="updateVariantScroll('scrollActiveVariant', $event)"
      #scrollActiveVariant
    >
      <app-danger-source-variant
        [variant]="activeVariant"
        [disabled]="isDisabled()"
        [isCompactMapLayout]="isCompactMapLayout"
        [isVariantsSidebarVisible]="isVariantsSidebarVisible"
        [isComparedVariant]="false"
        (updateVariantOnServerEvent)="updateVariantOnServer($event)"
        (deleteVariantEvent)="eventDeleteVariant($event)"
        (editMicroRegionsEvent)="eventEditMicroRegions($event)"
        (copyVariantEvent)="eventCopyVariant($event)"
        (deselectVariantEvent)="eventDeselectVariant($event)"
        (toggleVariantsSidebarEvent)="toggleVariantsSidebar($event)"
      ></app-danger-source-variant>
    </div>
    <!-- End Active variant -->
    <!-- Compared variant -->
    <div
      *ngIf="comparedVariant && !showNewVariantModal"
      class="create-bulletin__region-form"
      (scroll)="updateVariantScroll('scrollComparedVariant', $event)"
      #scrollComparedVariant
    >
      <app-danger-source-variant
        [variant]="comparedVariant"
        [disabled]="true"
        [isCompactMapLayout]="isCompactMapLayout"
        [isVariantsSidebarVisible]="isVariantsSidebarVisible"
        [isComparedVariant]="true"
        (deselectVariantEvent)="eventDeselectComparedVariant($event)"
      ></app-danger-source-variant>
    </div>
    <!-- End Compared variant -->

    <!-- Map -->
    <div class="create-bulletin__map-container" [class.create-bulletin__map-container--am-pm]="showAfternoonMap">
      <!-- Variant Sidebar toggle icon -->
      <button (click)="toggleVariantsSidebar()" class="create-bulletin__sidebar-close-on-map">
        <i class="ph ph-sidebar"></i>
      </button>
      <!-- End Variant Sidebar toggle icon -->
      <div class="floating-action create-region-floating-action" *ngIf="showNewVariantModal && activeVariant">
        <div class="floating-action__text">
          <i class="ph ph-map-trifold"></i> {{ "bulletins.create.mapSelectRegion" | translate }}
        </div>
        <div class="floating-action__actions btn-toolbar">
          <button type="reset" class="btn btn-bare" (click)="discardVariant($event, activeVariant)">
            <span>{{ "bulletins.create.tooltip.cancel" | translate }}</span>
          </button>
          <button type="button" class="btn btn-primary" (click)="saveVariant($event, activeVariant)">
            <i class="ph-bold ph-check"></i>
            <span *ngIf="activeVariant.regions.length === 0">{{
              "bulletins.create.tooltip.createRegion" | translate
            }}</span>
            <span *ngIf="activeVariant.regions.length > 0">{{
              "bulletins.create.tooltip.saveChanges" | translate
            }}</span>
          </button>
        </div>
      </div>

      <div id="map" class="create-bulletin__map create-bulletin__map--am"></div>
      <div id="afternoonMap" class="create-bulletin__map create-bulletin__map--pm"></div>
    </div>
    <!-- End Map -->
  </div>
</div>

<!-- Display this template when there are no variants -->
<ng-template #noVariantsTemplate>
  <div class="create-bulletin__nobulletins">
    <i class="ph ph-mountains"></i>
    <p>{{ "bulletins.create.noBulletinsForSelectedDay" | translate }}</p>
  </div>
</ng-template>

<ng-template #variantTemplate let-variant="variant">
  <div (click)="toggleVariant(variant)" class="region-thumb" [class.region-thumb--active]="variant === activeVariant">
    <div class="region-thumb__details">
      <h6 class="region-thumb__title font-s-medium" role="button">
        <span *ngIf="saveError.has(variant.id)">* </span>
        <span *ngIf="variant.regions.length > 0">{{ regionsService.getRegionName(variant.regions[0]) }}</span>
        <span *ngIf="variant.regions.length > 1"> + {{ variant.regions.length - 1 }} </span>
      </h6>
      <p class="region-thumb__author font-s text-secondary" role="button">{{ variant.getAuthor().getName() }}</p>

      <div class="region-thumb__avalanche-info">
        <app-danger-rating-icon [bulletinDaytimeDescription]="bulletin.forenoon"></app-danger-rating-icon>
        <!-- Avalanche problem -->
        <app-avalanche-problem-icons
          *ngIf="variant?.avalancheProblem"
          [value]="variant.avalancheProblem"
          class="region-thumb__avalanche-problem-icon"
        />
        <!-- Avalanche problem -->
        <!-- Elevations -->
        <span class="badge text-bg-light" *ngIf="variant.treelineHigh || variant.elevationHigh">
          <i class="ph ph-arrows-out-line-vertical icon-sm"></i>
          {{ variant.treelineHigh ? ("bulletins.create.tooltip.treeline" | translate) : variant.elevationHigh + " m" }}
        </span>
        <span class="badge text-bg-light" *ngIf="variant.treelineLow || variant.elevationLow">
          <i class="ph ph-arrows-out-line-vertical icon-sm"></i>
          {{ variant.treelineLow ? ("bulletins.create.tooltip.treeline" | translate) : variant.elevationLow + " m" }}
        </span>
        <!-- Elevations -->
      </div>
    </div>

    <div class="btn-group-vertical btn-group--border region-thumb__actions">
      <button
        *ngIf="!authenticationService.isCurrentUserInRole(constantsService.roleObserver)"
        [disabled]="loading || editRegions"
        type="button"
        class="btn btn-sm btn-bare btn-sm btn-icon"
        (click)="createVariant($event, variant)"
        data-toggle="tooltip"
        title="{{ 'bulletins.create.tooltip.copy' | translate }}"
      >
        <i class="ph ph-copy"></i>
      </button>

      <button
        *ngIf="dangerSourcesService.getIsEditable()"
        [disabled]="loading || editRegions"
        type="button"
        class="btn btn-sm btn-icon btn-bare"
        (click)="deleteVariant($event, variant)"
        data-toggle="tooltip"
        title="{{ 'bulletins.create.tooltip.delete' | translate }}"
      >
        <i class="ph ph-trash"></i>
      </button>

      <button
        *ngIf="activeVariant !== undefined && activeVariant !== variant"
        [disabled]="loading || editRegions"
        type="button"
        class="btn btn-bare btn-sm btn-icon"
        (click)="compareVariant($event, variant)"
      >
        <i class="ph ph-square-half"></i>
      </button>
    </div>
  </div>
</ng-template>

<ng-template #loadingErrorTemplate>
  <div class="modal-body text-center">
    <p>{{ "bulletins.create.loadingErrorDialog.message" | translate }}</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="loadingErrorModalConfirm()">
      {{ "bulletins.create.loadingErrorDialog.accept" | translate }}
    </button>
  </div>
</ng-template>

<ng-template #loadTemplate>
  <div class="modal-body text-center">
    <p>{{ "bulletins.create.loadDialog.message" | translate }}</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="loadModalConfirm($event)">
      {{ "bulletins.create.loadDialog.accept" | translate }}
    </button>
    <button type="button" class="btn btn-default" (click)="loadModalDecline($event)">
      {{ "bulletins.create.loadDialog.reject" | translate }}
    </button>
  </div>
</ng-template>

<ng-template #deleteAggregatedRegionTemplate>
  <div class="modal-body text-center">
    <p>{{ "bulletins.create.deleteAggregatedRegionDialog.message" | translate }}</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="deleteAggregatedRegionModalConfirm()">
      {{ "bulletins.create.deleteAggregatedRegionDialog.accept" | translate }}
    </button>
    <button type="button" class="btn btn-default" (click)="deleteAggregatedRegionModalDecline()">
      {{ "bulletins.create.deleteAggregatedRegionDialog.reject" | translate }}
    </button>
  </div>
</ng-template>

<ng-template #noRegionTemplate>
  <div class="modal-body text-center">
    <p>{{ "bulletins.create.noRegionDialog.message" | translate }}</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="noRegionModalConfirm()">
      {{ "bulletins.create.noRegionDialog.accept" | translate }}
    </button>
  </div>
</ng-template>

<ng-template #discardTemplate>
  <div class="modal-body text-center">
    <p>{{ "bulletins.create.discardDialog.message" | translate }}</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="discardModalConfirm()">
      {{ "bulletins.create.discardDialog.accept" | translate }}
    </button>
    <button type="button" class="btn btn-default" (click)="discardModalDecline()">
      {{ "bulletins.create.discardDialog.reject" | translate }}
    </button>
  </div>
</ng-template>

<ng-template #saveErrorTemplate>
  <div class="modal-body text-center">
    <p>{{ "bulletins.create.saveErrorDialog.message" | translate }}</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="saveErrorModalConfirm()">
      {{ "bulletins.create.saveErrorDialog.accept" | translate }}
    </button>
  </div>
</ng-template>
